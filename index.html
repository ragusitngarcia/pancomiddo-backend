<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pancomiddo Ventas</title>

    <link href="https://fonts.googleapis.com/css2?family=Grand+Hotel&display=swap" rel="stylesheet">

    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

    <style>
        :root {
            --primary: #d35400;
            --secondary: #e67e22;
            --bg: #f4f6f7;
            --dark: #2c3e50;
            --header-bg: #00121C;
            --green: #27ae60;
            --blue: #2980b9;
            --purple: #8e44ad;
            --orange: #f39c12;
            --red: #c0392b;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            margin: 0;
            background-color: var(--bg);
            color: var(--dark);
            padding-bottom: 50px;
        }

        /* ---------------------------------------------------------
           BLOQUE 2.1: HEADER (Barra superior y navegaci√≥n principal)
        ---------------------------------------------------------- */
        header {
            background: var(--header-bg);
            color: white;
            padding: 0 20px;
            height: 60px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            font-family: 'Grand Hotel', cursive;
            font-size: 1.6rem;
            color: #ffffff;
            white-space: nowrap;
            letter-spacing: 1px;
        }

        nav {
            display: flex;
            height: 100%;
            overflow-x: auto;
            align-items: center;
            margin-left: 20px;
            flex-grow: 1;
        }

        nav button {
            background: transparent;
            border: none;
            color: #bdc3c7;
            padding: 0 15px;
            font-size: 0.9rem;
            cursor: pointer;
            transition: 0.3s;
            height: 100%;
            border-bottom: 4px solid transparent;
            white-space: nowrap;
        }

        nav button:hover {
            background: rgba(255,255,255,0.05);
            color: white;
        }

        nav button.active {
            color: white;
            border-bottom-color: var(--primary);
            background: rgba(255,255,255,0.1);
            font-weight: bold;
        }

        .admin-controls {
            display: flex;
            gap: 10px;
        }

        .btn-header {
            padding: 5px 10px;
            font-size: 0.75rem;
            border-radius: 4px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            color: white;
            transition: 0.2s;
        }

        .container {
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .section {
            display: none;
            animation: fadeIn 0.3s;
        }

        .section.active {
            display: block;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 20px;
        }

        .btn {
            padding: 10px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            color: white;
            transition: 0.2s;
        }

        .btn-success { background: var(--green); }
        .btn-primary { background: var(--primary); }
        .btn-danger { background: var(--red); }
        .btn-info { background: var(--blue); }
        .btn-dark { background: var(--dark); }

        /* ---------------------------------------------------------
           BLOQUE 2.2: BANNER DE MODO EDICI√ìN DE PEDIDO
        ---------------------------------------------------------- */
        #editing-banner {
            display: none;
            background: #fff3cd;
            color: #856404;
            padding: 10px;
            text-align: center;
            margin-bottom: 15px;
            border-radius: 5px;
            border: 1px solid #ffeeba;
            font-weight: bold;
        }

        /* ---------------------------------------------------------
           BLOQUE 2.3: BOTONES DE TABLAS (Acciones por fila)
        ---------------------------------------------------------- */
        .btn-edit,
        .btn-del,
        .btn-msg {
            padding: 5px 8px;
            font-size: 0.9rem;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            border: none;
        }

        .btn-edit { background: #f39c12; margin-right: 3px; }
        .btn-del { background: #e74c3c; }
        .btn-msg { background: #34495e; margin-right: 3px; }

        input, select, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 10px;
            font-family: inherit;
        }

        /* ---------------------------------------------------------
           BLOQUE 2.4: LAYOUT POS (Punto de Venta)
        ---------------------------------------------------------- */
        .pos-container {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }

        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 12px;
        }

        .product-card {
            background: white;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.02);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 90px;
        }

        .product-card:hover {
            border-color: var(--primary);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .product-card h4 {
            margin: 0;
            font-size: 0.9rem;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .product-card .price {
            color: var(--primary);
            font-weight: bold;
            font-size: 1rem;
            margin-top: 5px;
        }

        /* ---------------------------------------------------------
           BLOQUE 2.5: BUSCADOR DE CLIENTES (POS)
        ---------------------------------------------------------- */
        .client-search-wrapper {
            position: relative;
            margin-bottom: 10px;
        }

        .client-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ddd;
            border-top: none;
            max-height: 200px;
            overflow-y: auto;
            z-index: 50;
            border-radius: 0 0 5px 5px;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .client-option {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        .client-option:hover {
            background-color: #f4f6f7;
        }

        /* ---------------------------------------------------------
           BLOQUE 2.6: CARRITO Y TABLAS GENERALES
        ---------------------------------------------------------- */
        .cart-item {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed #eee;
            padding: 8px 0;
            font-size: 0.95rem;
        }

        .cart-total-display {
            font-size: 2rem;
            font-weight: 800;
            text-align: right;
            color: var(--dark);
            margin: 20px 0;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
        }

        th {
            background: #f8f9fa;
            color: var(--primary);
        }

        /* ---------------------------------------------------------
           BLOQUE 2.7: COCINA (Producci√≥n y retiros)
        ---------------------------------------------------------- */
        .production-summary {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .prod-item-summary {
            background: #fff3e0;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid var(--secondary);
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        .order-card {
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            background: white;
            border-left: 5px solid var(--green);
            position: relative;
        }

        .order-card.pending { border-left-color: var(--orange); }
        .order-card.completed {
            border-left-color: #7f8c8d;
            background-color: #f8f9fa;
            opacity: 0.8;
        }

        .action-area {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px dashed #eee;
            display: flex;
            justify-content: flex-end;
        }

        /* ---------------------------------------------------------
           BLOQUE 2.8: INFORMES (Barras de ranking)
        ---------------------------------------------------------- */
        .bar-container { margin-bottom: 10px; }

        .bar-label {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            margin-bottom: 2px;
        }

        .bar-bg {
            background: #eee;
            height: 10px;
            border-radius: 5px;
            overflow: hidden;
        }

        .bar-fill {
            height: 100%;
            background: var(--primary);
            width: 0;
            transition: width 1s;
        }

        /* ---------------------------------------------------------
           BLOQUE 2.9: MODALES (Checkout, nuevo cliente, mensaje)
        ---------------------------------------------------------- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            width: 90%;
            max-width: 550px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            animation: slideUp 0.3s;
            max-height: 90vh;
            overflow-y: auto;
        }

        .checkout-tabs {
            display: flex;
            margin-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: bold;
            color: #999;
        }

        .tab-btn.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }

        .payment-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .pm-btn {
            padding: 12px;
            border: 2px solid #eee;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            font-weight: bold;
            transition: 0.2s;
            font-size: 0.9rem;
        }

        .pm-btn.selected {
            border-color: var(--dark);
            background: var(--dark);
            color: white;
        }

        .calc-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 1.2rem;
            margin-bottom: 10px;
        }

        .big-input {
            font-size: 1.5rem;
            padding: 10px;
            width: 150px;
            text-align: right;
            border: 2px solid var(--primary);
        }

        /* ---------------------------------------------------------
           BLOQUE 2.10: ANIMACIONES
        ---------------------------------------------------------- */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body>

<div id="pantalla-login" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--header-bg); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white;">
    <h1 style="font-family: 'Grand Hotel', cursive; font-size: 4rem; margin-bottom: 10px;">Pancomiddo</h1>
    <p style="margin-bottom: 20px;">Acceso restringido al personal</p>
    
    <input type="password" id="input-clave" placeholder="Ingresar clave..." style="width: 250px; text-align: center; font-size: 1.2rem; padding: 15px; border-radius: 8px; border: none; margin-bottom: 15px;">
    
    <button onclick="verificarClave()" style="background-color: var(--primary); color: white; border: none; padding: 15px 30px; font-size: 1.2rem; font-weight: bold; border-radius: 8px; cursor: pointer;">
        ENTRAR üîì
    </button>
</div>

<script>
    const CLAVE_SECRETA = "Nina&Wenchu";

    function verificarClave() {
        const intento = document.getElementById('input-clave').value;
        if (intento === CLAVE_SECRETA) {
            document.getElementById('pantalla-login').style.display = 'none';
        } else {
            alert("‚ùå Clave incorrecta. Intente de nuevo.");
            document.getElementById('input-clave').value = '';
        }
    }

    document.getElementById('input-clave').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            verificarClave();
        }
    });

    async function subirTodoASupabase() {
        if(!confirm("¬øEmpezar a copiar todos los clientes y productos a la nube?")) return;
        
        for (let c of db.clients) {
            await fetch('https://pancomiddo-backend.onrender.com/migrar-cliente', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(c)
            });
        }

        for (let p of db.products) {
            await fetch('https://pancomiddo-backend.onrender.com/migrar-producto', {
                method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(p)
            });
        }
        alert("¬°Migraci√≥n completa! Revisa las tablas en Supabase.");
    }
</script>

<header>
    <div class="logo">Pancomiddo</div>

    <nav>
        <button data-section="pos" onclick="showSection('pos', this)" class="active">üõí Venta</button>
        <button data-section="cocina" onclick="showSection('cocina', this)">üßë‚Äçüç≥ Cocina</button>
        <button data-section="ventas" onclick="showSection('ventas', this)">üìä Caja</button>
        <button data-section="informes" onclick="showSection('informes', this)">üìà Informes</button>
        <button data-section="productos" onclick="showSection('productos', this)">ü•ê Productos</button>
        <button data-section="clientes" onclick="showSection('clientes', this)">üë• Clientes</button>
    </nav>

    <div class="admin-controls">
        <button onclick="subirTodoASupabase()" class="btn-header" style="background-color: var(--orange);">üöÄ Migrar a Nube</button>
    </div>
</header>

<input type="file" id="import-clients-file" style="display:none" accept=".xlsx, .xls" onchange="importClientsXLSX(this)">
<input type="file" id="import-products-file" style="display:none" accept=".xlsx, .xls" onchange="importProductsXLSX(this)">
<input type="file" id="import-sales-file" style="display:none" accept=".xlsx, .xls" onchange="importSalesXLSX(this)">

<div class="container">

    <div id="pos" class="section active">
        <div class="pos-container">
            <div>
                <input type="text" placeholder="üîç Buscar producto..." onkeyup="renderProductsPOS(this.value)">
                <div id="pos-products-grid" class="product-grid"></div>
            </div>

            <div class="card" style="height: fit-content; position: sticky; top: 90px;">
                <h3 style="margin-top:0">Ticket Actual</h3>

                <div id="editing-banner">
                    ‚ö†Ô∏è MODO EDICI√ìN ‚ö†Ô∏è<br>
                    <span style="font-size:0.8rem; font-weight:normal">Est√°s modificando un pedido anterior.</span><br>
                    <a href="#" onclick="cancelEditMode()" style="font-size:0.8rem;">Cancelar</a>
                </div>

                <div class="client-search-wrapper">
                    <label style="font-size:0.85rem; color:#888;">Cliente:</label>
                    <input type="text" id="pos-client-search" placeholder="üë§ Buscar Cliente..." onkeyup="filterClientSearch()" onclick="toggleClientList()" autocomplete="off">
                    <div id="pos-client-list" class="client-dropdown"></div>
                </div>

                <div id="cart-list" style="min-height: 150px; max-height: 400px; overflow-y: auto;">
                    <p style="text-align:center; color:#999; margin-top:50px">Carrito vac√≠o</p>
                </div>

                <div class="cart-total-display">
                    <span id="cart-total">$ 0</span>
                </div>

                <button onclick="openCheckoutModal()" id="btn-checkout-main" class="btn btn-success" style="width: 100%; padding: 15px; font-size: 1.2rem;">üíµ COBRAR</button>
                <button onclick="clearCart()" class="btn btn-danger" style="width: 100%; margin-top: 10px;">üóëÔ∏è Limpiar</button>
            </div>
        </div>
    </div>

    <div id="cocina" class="section">
        <div class="card">
            <h2>üî• A Producir</h2>
            <div id="kitchen-summary" class="production-summary"></div>
        </div>

        <div class="card">
            <h3>‚è≥ Pendiente de Retiro</h3>
            <input type="text" id="kitchen-search" placeholder="üîç Buscar pedido..." onkeyup="renderKitchen()" style="background:#fff8e1; border-color:#f39c12; font-weight:bold;">
            <div id="kitchen-orders-pending"></div>
        </div>

        <div class="card" style="background-color: #f4f6f7; opacity: 0.9;">
            <h3>‚úÖ Ya Retirado</h3>
            <div id="kitchen-orders-completed"></div>
        </div>
    </div>

    <div id="ventas" class="section">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0">Gesti√≥n de Ventas</h3>
                <div style="display:flex; gap:5px;">
                    <button onclick="exportSalesXLSX()" class="btn btn-dark" style="font-size:0.8rem; padding:5px 10px;">üì§ Exportar Historial</button>
                    <button onclick="document.getElementById('import-sales-file').click()" class="btn btn-info" style="font-size:0.8rem; padding:5px 10px;">üì• Importar Historial</button>
                </div>
            </div>
        </div>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-top:20px;">
            <h2>üí∞ Cierre de Caja (Hoy)</h2>
            <h2 id="grand-total" style="color: var(--primary); font-size: 2rem;">$ 0</h2>
        </div>

        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; margin-bottom: 20px;">
            <div class="card" style="margin:0; text-align:center; border-top: 4px solid var(--green);">
                <div style="font-size:0.8rem; color:#888;">EFECTIVO</div>
                <div id="total-efectivo" style="font-size:1.5rem; font-weight:bold;">$0</div>
            </div>
            <div class="card" style="margin:0; text-align:center; border-top: 4px solid var(--blue);">
                <div style="font-size:0.8rem; color:#888;">MERCADO PAGO</div>
                <div id="total-mp" style="font-size:1.5rem; font-weight:bold;">$0</div>
            </div>
            <div class="card" style="margin:0; text-align:center; border-top: 4px solid var(--purple);">
                <div style="font-size:0.8rem; color:#888;">BANCARIA</div>
                <div id="total-transf" style="font-size:1.5rem; font-weight:bold;">$0</div>
            </div>
            <div class="card" style="margin:0; text-align:center; border-top: 4px solid var(--orange);">
                <div style="font-size:0.8rem; color:#888;">PENDIENTE</div>
                <div id="total-pendiente" style="font-size:1.5rem; font-weight:bold;">$0</div>
            </div>
        </div>

        <div class="card">
            <h3>Historial de Pedidos</h3>
            <div style="overflow-x:auto;">
                <table>
                    <thead>
                        <tr>
                            <th>Fecha/Hora</th><th>Tipo</th><th>Cliente</th><th>Detalle</th><th>Total</th><th>Pago</th><th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="sales-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="informes" class="section">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2>üìà Informes</h2>
        </div>
        <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap:20px;">
            <div class="card"><h3>üèÜ Top 5 Productos</h3><div id="report-top-products"></div></div>
            <div class="card"><h3>‚≠ê Top 5 Clientes</h3><div id="report-top-clients"></div></div>
        </div>
    </div>

    <div id="productos" class="section">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0">Productos</h3>
                <div style="display:flex; gap:5px;">
                    <button onclick="exportProductsXLSX()" class="btn btn-dark" style="font-size:0.8rem; padding:5px 10px;">üì§ Exportar Excel</button>
                    <button onclick="document.getElementById('import-products-file').click()" class="btn btn-info" style="font-size:0.8rem; padding:5px 10px;">üì• Importar Excel</button>
                </div>
            </div>
            <input type="text" placeholder="üîç Buscar..." onkeyup="renderProductsTable(this.value)">
            <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                <input type="text" id="prod-name" placeholder="Nuevo Nombre">
                <input type="number" id="prod-price" placeholder="Precio">
                <button onclick="addProduct()" class="btn btn-primary">Guardar</button>
            </div>
        </div>
        <div class="card">
            <table><tbody id="products-table-body"></tbody></table>
        </div>
    </div>

    <div id="clientes" class="section">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h3 style="margin:0">Clientes</h3>
                <div style="display:flex; gap:5px;">
                    <button onclick="exportClientsXLSX()" class="btn btn-dark" style="font-size:0.8rem; padding:5px 10px;">üì§ Exportar Excel</button>
                    <button onclick="document.getElementById('import-clients-file').click()" class="btn btn-info" style="font-size:0.8rem; padding:5px 10px;">üì• Importar Excel</button>
                </div>
            </div>
            <input type="text" placeholder="üîç Buscar..." onkeyup="renderClientsTable(this.value)">
            <div style="margin-top:10px; border-top:1px solid #eee; padding-top:10px;">
                <input type="text" id="client-name" placeholder="Nuevo Nombre">
                <input type="text" id="client-phone" placeholder="Tel/IG">
                <button onclick="addClient()" class="btn btn-primary">Guardar</button>
            </div>
        </div>
        <div class="card">
            <table><tbody id="clients-table-body"></tbody></table>
        </div>
    </div>

</div>

<div id="modal-checkout" class="modal">
    <div class="modal-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
            <span style="font-size:1.2rem; font-weight:bold;" id="checkout-title">Cobrar / Registrar</span>
            <span onclick="closeCheckout()" style="cursor:pointer; color:#999; font-size:1.5rem;">‚úï</span>
        </div>

        <div class="checkout-tabs" id="checkout-tabs-container">
            <div class="tab-btn active" id="tab-mostrador" onclick="setSaleType('Mostrador')">üõí MOSTRADOR (Ya)</div>
            <div class="tab-btn" id="tab-takeaway" onclick="setSaleType('TakeAway')">ü•° TAKE AWAY (Pedido)</div>
        </div>

        <div id="takeaway-options" style="display:none; background:#fef9e7; padding:15px; border-radius:8px; margin-bottom:15px;">
            <label style="font-size:0.9rem; font-weight:bold;">üìÖ Fecha y Hora de Retiro:</label>
            <div style="display:flex; gap:10px;">
                <input type="date" id="pickup-date">
                <input type="time" id="pickup-time" value="09:30">
            </div>
        </div>

        <div style="text-align:center; margin-bottom:15px; font-size:1.4rem;">
            Total: <b style="color:var(--primary)"><span id="checkout-total">$ 0</span></b>
        </div>

        <p style="margin-bottom:5px; color:#666; font-size:0.9rem;">Forma de Pago:</p>
        <div class="payment-grid">
            <div class="pm-btn selected" data-method="Efectivo" onclick="selectPayment('Efectivo', this)">üíµ Efectivo</div>
            <div class="pm-btn" data-method="Mercado Pago" onclick="selectPayment('Mercado Pago', this)">üì≤ MP</div>
            <div class="pm-btn" data-method="Transferencia" onclick="selectPayment('Transferencia', this)">üè¶ Transf.</div>
            <div class="pm-btn" data-method="Pendiente" onclick="selectPayment('Pendiente', this)">‚è≥ Pendiente</div>
        </div>

        <textarea id="sale-note" rows="2" placeholder="Notas..."></textarea>

        <div id="cash-calculator" style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:15px;">
            <div class="calc-row">
                <span>Abona con:</span>
                <input type="number" id="amount-paid" class="big-input" oninput="calculateChange()" placeholder="$">
            </div>
            <div class="calc-row" style="border-top:1px solid #ddd; padding-top:10px; margin-top:10px;">
                <span>Vuelto:</span>
                <span id="change-display" style="color:var(--red); font-weight:bold">$ 0</span>
            </div>
        </div>

        <button onclick="finalizeSale()" id="btn-final-confirm" class="btn btn-success" style="width:100%; padding:15px; font-size:1.2rem;">‚úÖ CONFIRMAR</button>
    </div>
</div>

<div id="modal-new-client" class="modal">
    <div class="modal-content">
        <h2>Nuevo Cliente</h2>
        <input type="text" id="modal-client-name" placeholder="Nombre">
        <input type="text" id="modal-client-phone" placeholder="Tel / IG">
        <button onclick="saveClientFromModal()" class="btn btn-primary" style="width:100%; margin-top:10px">Guardar</button>
        <button onclick="document.getElementById('modal-new-client').style.display='none'" class="btn btn-danger" style="width:100%; margin-top:10px">Cancelar</button>
    </div>
</div>

<div id="modal-msg" class="modal">
    <div class="modal-content">
        <h3>üí¨ Mensaje para Cliente</h3>
        <textarea id="msg-preview-area" rows="10" style="background:#f9f9f9; font-family:monospace; font-size:0.9rem;"></textarea>
        <button onclick="copyToClipboard()" class="btn btn-success" style="width:100%;">üìã COPIAR TEXTO</button>
        <button onclick="document.getElementById('modal-msg').style.display='none'" class="btn btn-danger" style="width:100%; margin-top:10px;">Cerrar</button>
    </div>
</div>

<script>
    const formatMoney = (a) => a.toLocaleString('es-AR', { style: 'currency', currency: 'ARS', minimumFractionDigits: 0 });

    const defaultProducts = [{'id': 100, 'name': 'Aceite de Oliva', 'price': 23000.0}, {'id': 101, 'name': 'Alfajores de Almendras', 'price': 2500.0}, {'id': 102, 'name': 'Alfajores de Dulce de Leche', 'price': 800.0}, {'id': 103, 'name': 'Alfajores de Maicena', 'price': 2000.0}, {'id': 104, 'name': 'Berenjenas en Escabeche', 'price': 7000.0}, {'id': 105, 'name': 'Brownie con Nuez', 'price': 1100.0}, {'id': 106, 'name': 'Brownie sin Nuez', 'price': 1000.0}, {'id': 107, 'name': 'Bud√≠n de Lim√≥n', 'price': 7000.0}, {'id': 108, 'name': 'Bud√≠n de Naranja', 'price': 7000.0}, {'id': 109, 'name': 'Bud√≠n de Naranja y Chocolate', 'price': 7000.0}, {'id': 110, 'name': 'Caja de Alfajores Surtidos', 'price': 3000.0}, {'id': 111, 'name': 'Chip√°', 'price': 6000.0}, {'id': 112, 'name': 'Chocotorta', 'price': 7000.0}, {'id': 113, 'name': 'Cookie Nutella', 'price': 3500.0}, {'id': 114, 'name': 'Cookie NYC', 'price': 3000.0}, {'id': 115, 'name': 'Cuadrado Coco y DDL', 'price': 5000.0}, {'id': 116, 'name': 'Cuadrado de Coco', 'price': 5000.0}, {'id': 117, 'name': 'Cuadrado de Rogel', 'price': 7000.0}, {'id': 118, 'name': 'Cuadrados de Lim√≥n', 'price': 400.0}, {'id': 119, 'name': 'Docena de Carne Copet√≠n', 'price': 23000.0}, {'id': 120, 'name': 'Docena de Verdura Copet√≠n', 'price': 23000.0}, {'id': 121, 'name': 'Dulce de Durazno', 'price': 6000.0}, {'id': 122, 'name': 'Dulce de Frutilla', 'price': 6000.0}, {'id': 123, 'name': 'Dulce de Naranja', 'price': 5300.0}, {'id': 124, 'name': 'Empanadas de Carne', 'price': 1800.0}, {'id': 125, 'name': 'Empanadas de Verdura', 'price': 1800.0}, {'id': 126, 'name': 'Focaccia', 'price': 8000.0}, {'id': 127, 'name': 'Galletitas Cruz', 'price': 500.0}, {'id': 128, 'name': 'Macarons', 'price': 3000.0}, {'id': 129, 'name': 'Marquise DDL Crema y Frutos Rojos', 'price': 17000.0}, {'id': 130, 'name': 'Masitas Sabl√©e', 'price': 300.0}, {'id': 131, 'name': 'Miel', 'price': 6000.0}, {'id': 132, 'name': 'Mousse de Chocolate', 'price': 7800.0}, {'id': 133, 'name': 'Muffin de Ar√°ndanos', 'price': 3500.0}, {'id': 134, 'name': 'Muffin de Vainilla', 'price': 3000.0}, {'id': 135, 'name': 'Pan Blanco', 'price': 7000.0}, {'id': 136, 'name': 'Pan Integral', 'price': 7000.0}, {'id': 137, 'name': 'Pastafrola de Batata', 'price': 4800.0}, {'id': 138, 'name': 'Pepinillos', 'price': 7000.0}, {'id': 139, 'name': 'Porci√≥n de Rogel', 'price': 7500.0}, {'id': 140, 'name': 'Postre Franui', 'price': 7500.0}, {'id': 141, 'name': 'Postre Tiramis√∫', 'price': 7500.0}, {'id': 142, 'name': 'Rogel', 'price': 7000.0}, {'id': 143, 'name': 'Rogel Grande', 'price': 54000.0}, {'id': 144, 'name': 'Roll de Canela', 'price': 5000.0}, {'id': 145, 'name': 'Scones de Queso', 'price': 6000.0}, {'id': 146, 'name': 'Torta Chocolate', 'price': 20000.0}, {'id': 147, 'name': 'Torta Grande Bariloche', 'price': 58000.0}, {'id': 148, 'name': 'Torta Grande Key Lime Pie', 'price': 58000.0}, {'id': 149, 'name': 'Torta Grande Lemon Pie', 'price': 58000.0}, {'id': 150, 'name': 'Torta Grande Marquise Franui', 'price': 58000.0}, {'id': 151, 'name': 'Torta Grande Matilda', 'price': 58000.0}, {'id': 152, 'name': 'Torta Grande Pancomiddo', 'price': 58000.0}, {'id': 153, 'name': 'Torta Grande Pancomiddo Duraznos', 'price': 58000.0}, {'id': 154, 'name': 'Torta Mediana Bariloche', 'price': 44000.0}, {'id': 155, 'name': 'Torta Mediana Marquise Franui', 'price': 45000.0}, {'id': 156, 'name': 'Torta Mediana Pancomiddo Frutillas', 'price': 46000.0}, {'id': 157, 'name': 'Tortita Marquise', 'price': 13000.0}, {'id': 158, 'name': 'Tortita Marquise Franui', 'price': 18000.0}, {'id': 159, 'name': 'Tortita Rogel', 'price': 13000.0}];

    const defaultClients = [
        {'id': 1000, 'name': 'Abu', 'phone': ''}, {'id': 1001, 'name': 'Adriana Casaretto', 'phone': ''}, {'id': 1002, 'name': 'Agus Y Clari', 'phone': ''}, {'id': 1003, 'name': 'Agus Y Matu', 'phone': ''}, {'id': 1004, 'name': 'Agustina Pereira', 'phone': ''},
        {'id': 1005, 'name': 'Albert', 'phone': ''}, {'id': 1006, 'name': 'Ale Serrani', 'phone': ''}, {'id': 1007, 'name': 'Alejandra Bojorge', 'phone': ''}, {'id': 1008, 'name': 'Ali Santana', 'phone': ''}, {'id': 1009, 'name': 'Alita', 'phone': ''},
        {'id': 1010, 'name': 'Amaik√©', 'phone': ''}, {'id': 1011, 'name': 'Ana Paula', 'phone': ''}, {'id': 1012, 'name': 'Andy', 'phone': ''}, {'id': 1013, 'name': 'Anto Y Mati', 'phone': ''}, {'id': 1014, 'name': 'Baigo', 'phone': ''},
        {'id': 1015, 'name': 'Barby', 'phone': ''}, {'id': 1016, 'name': 'Betina', 'phone': ''}, {'id': 1017, 'name': 'Brian', 'phone': ''}, {'id': 1018, 'name': 'Cami', 'phone': ''}, {'id': 1019, 'name': 'Cami Y Jos√©', 'phone': ''},
        {'id': 1020, 'name': 'Caro Roca', 'phone': ''}, {'id': 1021, 'name': 'Caro Y Nano', 'phone': ''}, {'id': 1022, 'name': 'Carlos Y Susana', 'phone': ''}, {'id': 1023, 'name': 'Casa', 'phone': ''}, {'id': 1024, 'name': 'Cecilia Gulland', 'phone': ''},
        {'id': 1025, 'name': 'Daniela Giraudo', 'phone': ''}, {'id': 1026, 'name': 'Denise', 'phone': ''}, {'id': 1027, 'name': 'Desayuno Syngenta', 'phone': ''}, {'id': 1028, 'name': 'Ele Y Pablito', 'phone': ''}, {'id': 1029, 'name': 'Elena Y Pablito', 'phone': ''},
        {'id': 1030, 'name': 'Emi', 'phone': ''}, {'id': 1031, 'name': 'Eva', 'phone': ''}, {'id': 1032, 'name': 'Facu Hernandez', 'phone': ''}, {'id': 1033, 'name': 'Familia', 'phone': ''}, {'id': 1034, 'name': 'Fede', 'phone': ''},
        {'id': 1035, 'name': 'Fer Nieto', 'phone': ''}, {'id': 1036, 'name': 'Fernanda Aldeco', 'phone': ''}, {'id': 1037, 'name': 'Gaby', 'phone': ''}, {'id': 1038, 'name': 'Giuli', 'phone': ''}, {'id': 1039, 'name': 'Gonza Y Juli', 'phone': ''},
        {'id': 1040, 'name': 'Graciela Abuela Pepe', 'phone': ''}, {'id': 1041, 'name': 'Guada Millenial', 'phone': ''}, {'id': 1042, 'name': 'Horacio Hernandez', 'phone': ''}, {'id': 1043, 'name': 'Indi', 'phone': ''}, {'id': 1044, 'name': 'Ingrid', 'phone': ''},
        {'id': 1045, 'name': 'Jacque', 'phone': ''}, {'id': 1046, 'name': 'Joaco Echeverria', 'phone': ''}, {'id': 1047, 'name': 'Josefina', 'phone': ''}, {'id': 1048, 'name': 'Juli', 'phone': ''}, {'id': 1049, 'name': 'Juli Y Mati', 'phone': ''},
        {'id': 1050, 'name': 'Lau', 'phone': ''}, {'id': 1051, 'name': 'Laura', 'phone': ''}, {'id': 1052, 'name': 'Laura Kushidonchi', 'phone': ''}, {'id': 1053, 'name': 'Lauro', 'phone': ''}, {'id': 1054, 'name': 'Leila', 'phone': ''},
        {'id': 1055, 'name': 'Leo', 'phone': ''}, {'id': 1056, 'name': 'Leonardo', 'phone': ''}, {'id': 1057, 'name': 'Lili Amiga Gra', 'phone': ''}, {'id': 1058, 'name': 'Lili Echeverria', 'phone': ''}, {'id': 1059, 'name': 'Lili Y Familia', 'phone': ''},
        {'id': 1060, 'name': 'Lili Y Luis', 'phone': ''}, {'id': 1061, 'name': 'Lili Y Vicente', 'phone': ''}, {'id': 1062, 'name': 'Lili, Joaco, Luis Y Vicente', 'phone': ''}, {'id': 1063, 'name': 'Lionel', 'phone': ''}, {'id': 1064, 'name': 'Lorena', 'phone': ''},
        {'id': 1065, 'name': 'Lou', 'phone': ''}, {'id': 1066, 'name': 'Lu Canepa', 'phone': ''}, {'id': 1067, 'name': 'Lucia', 'phone': ''}, {'id': 1068, 'name': 'Lucia Lavigna', 'phone': ''}, {'id': 1069, 'name': 'Lucre Servin', 'phone': ''},
        {'id': 1070, 'name': 'Lucrecia', 'phone': ''}, {'id': 1071, 'name': 'Lucrecia Y Facu', 'phone': ''}, {'id': 1072, 'name': 'Lucrecia Y Facu Servin', 'phone': ''}, {'id': 1073, 'name': 'Lucrecia, Facu Y Tobias', 'phone': ''}, {'id': 1074, 'name': 'Lucrecia, Facu, Nieve, Luis Y Vicen', 'phone': ''},
        {'id': 1075, 'name': 'Lucy', 'phone': ''}, {'id': 1076, 'name': 'Luisa', 'phone': ''}, {'id': 1077, 'name': 'Luisa Y Familia', 'phone': ''}, {'id': 1078, 'name': 'Luisa Y Piba', 'phone': ''}, {'id': 1079, 'name': 'Luisa Y Rober', 'phone': ''},
        {'id': 1080, 'name': 'Luisa, Rober Y Piba', 'phone': ''}, {'id': 1081, 'name': 'Luisa, Rober, Lili Y Vicente', 'phone': ''}, {'id': 1082, 'name': 'Mami Papi Joaco', 'phone': ''}, {'id': 1083, 'name': 'Manu Scotto', 'phone': ''}, {'id': 1084, 'name': 'Manuel Roca', 'phone': ''},
        {'id': 1085, 'name': 'Mariana', 'phone': ''}, {'id': 1086, 'name': 'Mariana Burzio', 'phone': ''}, {'id': 1087, 'name': 'Mariana H', 'phone': ''}, {'id': 1088, 'name': 'Marina Farese', 'phone': ''}, {'id': 1089, 'name': 'Mart√≠n Y Meli', 'phone': ''},
        {'id': 1090, 'name': 'Mart√≠n, Meli Benja', 'phone': ''}, {'id': 1091, 'name': 'Matias', 'phone': ''}, {'id': 1092, 'name': 'Matilde', 'phone': ''}, {'id': 1093, 'name': 'Meli', 'phone': ''}, {'id': 1094, 'name': 'Meli Y Benja', 'phone': ''},
        {'id': 1095, 'name': 'Miguel', 'phone': ''}, {'id': 1096, 'name': 'Milagros', 'phone': ''}, {'id': 1097, 'name': 'Mili', 'phone': ''}, {'id': 1098, 'name': 'Mili Ferreira', 'phone': ''}, {'id': 1099, 'name': 'Millenial', 'phone': ''},
        {'id': 1100, 'name': 'Nanu Echeverria', 'phone': ''}, {'id': 1101, 'name': 'Nicole Ferrarino', 'phone': ''}, {'id': 1102, 'name': 'Olga', 'phone': ''}, {'id': 1103, 'name': 'Orne Cantuni', 'phone': ''}, {'id': 1104, 'name': 'Orne Verona', 'phone': ''},
        {'id': 1105, 'name': 'Padre Robert', 'phone': ''}, {'id': 1106, 'name': 'Paola', 'phone': ''}, {'id': 1107, 'name': 'Paumi', 'phone': ''}, {'id': 1108, 'name': 'Paloma', 'phone': ''}, {'id': 1109, 'name': 'Pili Piola', 'phone': ''},
        {'id': 1110, 'name': 'Pili Piola Producciones', 'phone': ''}, {'id': 1111, 'name': 'Pili Y Familia', 'phone': ''}, {'id': 1112, 'name': 'Pili, Lauro, Panchi Y Patate', 'phone': ''}, {'id': 1113, 'name': 'Remis', 'phone': ''}, {'id': 1114, 'name': 'Roc√≠o Ojeda', 'phone': ''},
        {'id': 1115, 'name': 'Romi', 'phone': ''}, {'id': 1116, 'name': 'Romina', 'phone': ''}, {'id': 1117, 'name': 'Sabri', 'phone': ''}, {'id': 1118, 'name': 'Servil', 'phone': ''}, {'id': 1119, 'name': 'Silvia', 'phone': ''},
        {'id': 1120, 'name': 'Silvi', 'phone': ''}, {'id': 1121, 'name': 'Tati Ferreyra', 'phone': ''}, {'id': 1122, 'name': 'Tony', 'phone': ''}, {'id': 1123, 'name': 'Vale', 'phone': ''}, {'id': 1124, 'name': 'Vanina Alassia', 'phone': ''},
        {'id': 1125, 'name': 'Verduler√≠a Miriam', 'phone': ''}, {'id': 1126, 'name': 'Vero', 'phone': ''}, {'id': 1127, 'name': 'Vicente', 'phone': ''}, {'id': 1128, 'name': 'Vicky Varela', 'phone': ''}, {'id': 1129, 'name': 'Vicky Zavattaro', 'phone': ''},
        {'id': 1130, 'name': 'Victoria Saubidet', 'phone': ''}, {'id': 1131, 'name': 'Vir', 'phone': ''}, {'id': 1132, 'name': 'Virginia', 'phone': ''}, {'id': 1133, 'name': 'Vivi Ferreira', 'phone': ''}, {'id': 1134, 'name': 'Yesica', 'phone': ''}
    ];

    let savedProds   = JSON.parse(localStorage.getItem('pan_prods_v18'))   || defaultProducts;
    let savedClients = JSON.parse(localStorage.getItem('pan_clients_v18')) || defaultClients;
    let savedSales   = JSON.parse(localStorage.getItem('pan_sales_v18'))   || [];

    let db = { products: savedProds, clients: savedClients, sales: savedSales };

    db.sales.forEach(s => {
        if (s.pickedUp === undefined) s.pickedUp = (s.type === 'Mostrador');
        if (!s.timestamp) s.timestamp = s.date ? new Date(s.date) : new Date();
        else s.timestamp = new Date(s.timestamp);
    });

    let cart = {};                             
    let currentPaymentMethod = 'Efectivo';     
    let currentCheckoutTotal = 0;              
    let saleType = 'Mostrador';                
    let pendingOrderIdToPay = null;            
    let editingSaleId = null;                  

    function init() {
        renderProductsPOS();
        renderProductsTable();
        renderClientsTable();
        renderClientSearchList();
        updateReport();
        renderSalesTable();
        renderKitchen();
        renderAnalytics();

        document.addEventListener('click', e => {
            if (!e.target.closest('.client-search-wrapper')) {
                document.getElementById('pos-client-list').style.display = 'none';
            }
        });
    }

    function saveDB() {
        localStorage.setItem('pan_prods_v18', JSON.stringify(db.products));
        localStorage.setItem('pan_clients_v18', JSON.stringify(db.clients));
        localStorage.setItem('pan_sales_v18', JSON.stringify(db.sales));
    }

    function showSection(id, btn) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
        if (!btn) btn = document.querySelector(`nav button[data-section="${id}"]`);
        if (btn) btn.classList.add('active');
        if (id === 'cocina') renderKitchen();
        if (id === 'informes') renderAnalytics();
    }

    function exportSalesXLSX() {
        const data = db.sales.map(s => ({
            Fecha: s.date.split(',')[0],
            Hora:  s.date.split(',')[1] || '',
            Tipo:  s.type,
            Cliente: s.client,
            Detalle: s.details,
            Nota:    s.note,
            Metodo:  s.method,
            Estado:  s.pickedUp ? "Entregado" : "Pendiente",
            Total:   s.total
        }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Ventas");
        XLSX.writeFile(wb, `Historial_Ventas_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    function importSalesXLSX(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.readAsArrayBuffer(file);
        reader.onload = (e) => {
            const wb = XLSX.read(e.target.result, {type:'array'});
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            let count = 0;
            data.forEach(row => {
                const dateStr   = row['Fecha'] || '';
                const timeStr   = row['Hora'] || '';
                const type      = row['Tipo'] || 'Mostrador';
                const client    = row['Cliente'] || 'Mostrador';
                const detailsStr= row['Detalle'] || '';
                const note      = row['Nota'] || '';
                const method    = row['Metodo'] || 'Efectivo';
                const status    = row['Estado'] || 'Entregado';
                const total     = parseFloat(row['Total']) || 0;

                let items = [];
                if (detailsStr) {
                    detailsStr.split(',').forEach(part => {
                        const match = part.match(/(.*)\s\(x(\d+)\)/);
                        if (match) {
                            items.push({name: match[1].trim(), qty: parseInt(match[2])});
                        }
                    });
                }

                const newSale = {
                    id: Date.now() + Math.random(),
                    date: dateStr + (timeStr ? ', ' + timeStr : ''),
                    timestamp: new Date(),
                    type: type,
                    pickupSort: new Date(),
                    pickupInfo: '',
                    client: client,
                    total: total,
                    method: method,
                    items: items,
                    details: detailsStr,
                    note: note,
                    pickedUp: (status === 'Entregado')
                };
                db.sales.push(newSale);
                count++;
            });
            saveDB();
            renderSalesTable();
            updateReport();
            renderKitchen();
            alert(`‚úÖ ${count} ventas importadas al historial.`);
        };
    }

    function exportProductsXLSX() {
        const ws = XLSX.utils.json_to_sheet(db.products.map(p => ({ Producto: p.name, Precio: p.price })));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Productos");
        XLSX.writeFile(wb, "Lista_Precios.xlsx");
    }

    function exportClientsXLSX() {
        const ws = XLSX.utils.json_to_sheet(db.clients.map(c => ({ Nombre: c.name, Telefono: c.phone })));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Clientes");
        XLSX.writeFile(wb, "Lista_Clientes.xlsx");
    }

    function importProductsXLSX(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.readAsArrayBuffer(file);
        reader.onload = (e) => {
            const wb = XLSX.read(e.target.result, {type:'array'});
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            let up = 0, nw = 0;
            data.forEach(row => {
                const name  = row['Producto'] || row['Nombre'] || row['name'];
                const price = row['Precio']   || row['Price']   || row['price'];
                if (name && price) {
                    const ex = db.products.find(p => p.name === name);
                    if (ex) {
                        ex.price = parseFloat(price);
                        up++;
                    } else {
                        db.products.push({ id: Date.now() + Math.random(), name, price: parseFloat(price) });
                        nw++;
                    }
                }
            });
            saveDB();
            renderProductsTable();
            renderProductsPOS();
            alert(`‚úÖ ${nw} nuevos, üîÑ ${up} actualizados.`);
        };
    }

    function importClientsXLSX(input) {
        const file = input.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.readAsArrayBuffer(file);
        reader.onload = (e) => {
            const wb = XLSX.read(e.target.result, {type:'array'});
            const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            let nw = 0;
            data.forEach(row => {
                const name  = row['Nombre'] || row['Name'];
                const phone = row['Telefono'] || row['Tel'] || row['Phone'] || '';
                if (name && !db.clients.find(c => c.name === name)) {
                    db.clients.push({ id: Date.now() + Math.random(), name, phone });
                    nw++;
                }
            });
            saveDB();
            renderClientsTable();
            renderClientSearchList();
            alert(`‚úÖ ${nw} clientes importados.`);
        };
    }

    function renderProductsPOS(f = "") {
        const filtro = f.toLowerCase();
        document.getElementById('pos-products-grid').innerHTML = db.products
            .filter(p => p.name.toLowerCase().includes(filtro))
            .map(p => `
                <div class="product-card" onclick="addToCart(${p.id})">
                    <h4>${p.name}</h4>
                    <div class="price">${formatMoney(p.price)}</div>
                </div>
            `).join('');
    }

    function addToCart(id) {
        cart[id] = (cart[id] || 0) + 1;
        renderCart();
    }

    function removeFromCart(id) {
        delete cart[id];
        renderCart();
    }

    function clearCart() {
        if (editingSaleId && !confirm("¬øEst√°s seguro? Perder√°s los cambios de la edici√≥n.")) return;
        cart = {};
        editingSaleId = null;
        cancelEditMode(); 
        renderCart();
    }

    function renderCart() {
        const l = document.getElementById('cart-list');
        let t = 0, h = '';
        for (const [id, q] of Object.entries(cart)) {
            const p = db.products.find(x => x.id == id);
            if (p) {
                t += p.price * q;
                h += `
                    <div class="cart-item">
                        <div>${p.name} <strong>x${q}</strong></div>
                        <div>
                            <b>${formatMoney(p.price * q)}</b>
                            <span onclick="removeFromCart(${id})" style="color:red;cursor:pointer">‚úï</span>
                        </div>
                    </div>`;
            }
        }
        l.innerHTML = h || '<p style="text-align:center;color:#999;margin-top:50px">Carrito vac√≠o</p>';
        document.getElementById('cart-total').innerText = formatMoney(t);
        currentCheckoutTotal = t;
    }

    function filterClientSearch() {
        const term = document.getElementById('pos-client-search').value.toLowerCase();
        renderClientSearchList(term);
        document.getElementById('pos-client-list').style.display = 'block';
    }

    function toggleClientList() {
        document.getElementById('pos-client-list').style.display = 'block';
    }

    function selectClient(n) {
        document.getElementById('pos-client-search').value = n;
        document.getElementById('pos-client-list').style.display = 'none';
        if (n === 'NEW') {
            document.getElementById('modal-new-client').style.display = 'flex';
        }
    }

    function renderClientSearchList(f = "") {
        let h = `
            <div class="client-option" onclick="selectClient('Mostrador')"><strong>Mostrador</strong></div>
            <div class="client-option" onclick="selectClient('NEW')"><strong>‚ûï NUEVO...</strong></div>
        `;
        db.clients.filter(c => c.name.toLowerCase().includes(f)).forEach(c => {
            h += `<div class="client-option" onclick="selectClient('${c.name}')">${c.name}</div>`;
        });
        document.getElementById('pos-client-list').innerHTML = h;
    }

    function openCheckoutModal(ex = null) {
        if (ex) {
            pendingOrderIdToPay = ex.id;
            currentCheckoutTotal = ex.total;
            document.getElementById('checkout-tabs-container').style.display = 'none';
            document.getElementById('takeaway-options').style.display = 'none';
        } else {
            if (currentCheckoutTotal === 0) return alert("Vac√≠o");
            pendingOrderIdToPay = null;
            document.getElementById('checkout-tabs-container').style.display = 'flex';
            setSaleType(saleType); 
        }

        document.getElementById('checkout-total').innerText = formatMoney(currentCheckoutTotal);
        document.getElementById('amount-paid').value = '';
        document.getElementById('sale-note').value = ex ? (ex.note || '') : '';
        document.getElementById('change-display').innerText = '$ 0';

        if (editingSaleId) {
            document.getElementById('checkout-title').innerText = "‚úèÔ∏è Guardar Cambios";
            document.getElementById('btn-final-confirm').innerText = "üíæ ACTUALIZAR PEDIDO";
            document.getElementById('btn-final-confirm').classList.remove('btn-success');
            document.getElementById('btn-final-confirm').classList.add('btn-primary');
            selectPayment(currentPaymentMethod);
        } else {
            document.getElementById('checkout-title').innerText = "Cobrar / Registrar";
            document.getElementById('btn-final-confirm').innerText = "‚úÖ CONFIRMAR";
            document.getElementById('btn-final-confirm').classList.remove('btn-primary');
            document.getElementById('btn-final-confirm').classList.add('btn-success');
            selectPayment('Efectivo');
        }

        document.getElementById('modal-checkout').style.display = 'flex';
        setTimeout(() => document.getElementById('amount-paid').focus(), 100);
    }

    function setSaleType(t) {
        saleType = t;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        if (t === 'Mostrador') {
            document.getElementById('tab-mostrador').classList.add('active');
            document.getElementById('takeaway-options').style.display = 'none';
        } else {
            document.getElementById('tab-takeaway').classList.add('active');
            document.getElementById('takeaway-options').style.display = 'block';
            const d = new Date();
            d.setDate(d.getDate() + ((6 + 7 - d.getDay()) % 7 || 7)); 
            document.getElementById('pickup-date').value = d.toISOString().split('T')[0];
            document.getElementById('pickup-time').value = "09:30";
        }
    }

    function selectPayment(m, b = null) {
        currentPaymentMethod = m;
        const buttons = document.querySelectorAll('.pm-btn');
        buttons.forEach(x => x.classList.remove('selected'));
        if (!b) {
            b = Array.from(buttons).find(btn => btn.getAttribute('data-method') === m) || buttons[0];
        }
        if (b) b.classList.add('selected');
        document.getElementById('cash-calculator').style.display = (m === 'Efectivo') ? 'block' : 'none';
    }

    function calculateChange() {
        const pagado = parseFloat(document.getElementById('amount-paid').value) || 0;
        const diferencia = pagado - currentCheckoutTotal;
        const d = document.getElementById('change-display');

        if (diferencia >= 0) {
            d.innerText = formatMoney(diferencia);
            d.style.color = 'var(--green)';
        } else {
            d.innerText = 'Falta ' + formatMoney(Math.abs(diferencia));
            d.style.color = 'var(--red)';
        }
    }

    function closeCheckout() {
        document.getElementById('modal-checkout').style.display = 'none';
    }

    function finalizeSale() {
        if (currentPaymentMethod === 'Efectivo') {
            const pagado = parseFloat(document.getElementById('amount-paid').value) || 0;
            if (pagado < currentCheckoutTotal) return alert("Monto insuficiente");
        }

        // Pagar deuda pendiente (Cocina)
        if (pendingOrderIdToPay) {
            const idx = db.sales.findIndex(s => s.id === pendingOrderIdToPay);
            if (idx !== -1) {
                db.sales[idx].method  = currentPaymentMethod;
                db.sales[idx].pickedUp = true;
                db.sales[idx].note   = document.getElementById('sale-note').value;
                saveDB();
                renderKitchen();
                renderSalesTable();
                updateReport();

                // Sincronizar pago con la nube
                const o = db.sales[idx];
                fetch(`https://pancomiddo-backend.onrender.com/actualizar-venta/${o.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cliente_id: db.clients.find(c => c.name === o.client)?.id || null,
                        total: o.total,
                        metodoPago: o.method,
                        tipo: o.type,
                        nota: o.note,
                        infoRetiro: o.pickupInfo,
                        entregado: true
                    })
                }).catch(err => console.error(err));
            }
            closeCheckout();
            alert("¬°Listo!");
            return;
        }

        let cli = document.getElementById('pos-client-search').value || "Mostrador";
        let clienteObjeto = db.clients.find(c => c.name === cli);
        let clienteId = clienteObjeto ? clienteObjeto.id : null; 
        
        let items = [];
        let det = [];

        for (const [id, q] of Object.entries(cart)) {
            const p = db.products.find(x => x.id == id);
            if (p) {
                items.push({ id: p.id, price: p.price, name: p.name, qty: q });
                det.push(`${p.name} (x${q})`);
            }
        }

        let pi = "";
        let sd = new Date();
        if (saleType === 'TakeAway') {
            pi = `${document.getElementById('pickup-date').value} ${document.getElementById('pickup-time').value}`;
            sd = new Date(pi.replace(' ', 'T'));
        }

        const noteText = document.getElementById('sale-note').value;

        // EDICI√ìN DE VENTA EXISTENTE
        if (editingSaleId) {
            const idx = db.sales.findIndex(s => s.id === editingSaleId);
            if (idx !== -1) {
                db.sales[idx].client  = cli;
                db.sales[idx].total   = currentCheckoutTotal;
                db.sales[idx].method  = currentPaymentMethod;
                db.sales[idx].items   = items;
                db.sales[idx].details = det.join(', ');
                db.sales[idx].note    = noteText;
                db.sales[idx].type    = saleType;

                if (saleType === 'TakeAway') {
                    db.sales[idx].pickupInfo = pi;
                    db.sales[idx].pickupSort = sd;
                }
            }
            
            // Sincronizar Edici√≥n
            fetch(`https://pancomiddo-backend.onrender.com/actualizar-venta/${editingSaleId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    cliente_id: clienteId,
                    total: currentCheckoutTotal,
                    metodoPago: currentPaymentMethod,
                    tipo: saleType,
                    items: items, 
                    nota: noteText,
                    infoRetiro: pi,
                    entregado: (saleType === 'Mostrador')
                })
            }).catch(err => console.error(err));
            
            alert("‚úÖ Pedido Actualizado en local y nube");

        // NUEVA VENTA
        } else {
            const newSaleId = Date.now();
            db.sales.unshift({
                id: newSaleId,
                date: new Date().toLocaleString(),
                timestamp: new Date(),
                type: saleType,
                pickupSort: sd,
                pickupInfo: pi,
                client: cli,
                total: currentCheckoutTotal,
                method: currentPaymentMethod,
                items: items,
                details: det.join(', '),
                note: noteText,
                pickedUp: (saleType === 'Mostrador')
            });

            // Sincronizar Nueva
            fetch('https://pancomiddo-backend.onrender.com/guardar-venta', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: newSaleId,
                    cliente_id: clienteId, 
                    total: currentCheckoutTotal,
                    metodoPago: currentPaymentMethod,
                    fecha: new Date().toLocaleString(),
                    tipo: saleType,
                    detalles: det.join(', '),
                    items: items,          
                    nota: noteText,
                    infoRetiro: pi,
                    entregado: (saleType === 'Mostrador')
                })
            }).catch(err => console.error(err));

            alert("¬°Venta Registrada en local y nube!");
        }

        saveDB();
        closeCheckout();
        clearCart();
        updateReport();
        renderSalesTable();
        renderKitchen();
        document.getElementById('pos-client-search').value = "";
    }

    function viewOrderMsg(id) {
        const sale = db.sales.find(s => s.id === id);
        if (!sale) return;

        const msg = `Hola ${sale.client}, te paso el resumen de tu pedido:\n\n` +
            `üìù ${sale.details}\n\n` +
            `üí∞ Total final: ${formatMoney(sale.total)}\n\n` +
            `üí≥ Alias MercadoPago: pancomiddo\n` +
            `üë§ Titular: Martin Rossi\n\n` +
            `¬øMe envi√°s el comprobante para confirmar? Gracias!`;

        document.getElementById('msg-preview-area').value = msg;
        document.getElementById('modal-msg').style.display = 'flex';
    }

    function copyToClipboard() {
        const copyText = document.getElementById("msg-preview-area");
        copyText.select();
        copyText.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(copyText.value);
        alert("Copiado al portapapeles");
    }

    function loadSaleForEdit(id) {
        if (Object.keys(cart).length > 0 && !editingSaleId) {
            if (!confirm("‚ö†Ô∏è Hay productos en el carrito actual. Si editas este pedido, se perder√° lo que estabas cargando. ¬øContinuar?")) return;
        }

        const sale = db.sales.find(s => s.id === id);
        if (!sale) return;

        cart = {};
        sale.items.forEach(item => {
            const prod = db.products.find(p => p.name === item.name);
            if (prod) {
                cart[prod.id] = item.qty;
            } else {
                console.warn("Producto no encontrado en BD actual:", item.name);
            }
        });

        editingSaleId = sale.id;
        saleType = sale.type;
        currentPaymentMethod = sale.method;
        document.getElementById('pos-client-search').value = sale.client;

        renderCart();
        showSection('pos');

        document.getElementById('editing-banner').style.display = 'block';
        document.getElementById('btn-checkout-main').innerText = "üîÑ ACTUALIZAR PEDIDO";
        document.getElementById('btn-checkout-main').classList.remove('btn-success');
        document.getElementById('btn-checkout-main').classList.add('btn-primary');

        alert("üîÑ Pedido cargado en el Carrito.\n\nModifica los productos o el pago y haz clic en 'ACTUALIZAR PEDIDO' para guardar.");
    }

    function cancelEditMode() {
        editingSaleId = null;
        document.getElementById('editing-banner').style.display = 'none';
        document.getElementById('pos-client-search').value = "";
        document.getElementById('btn-checkout-main').innerText = "üíµ COBRAR";
        document.getElementById('btn-checkout-main').classList.remove('btn-primary');
        document.getElementById('btn-checkout-main').classList.add('btn-success');
        saleType = 'Mostrador';
        cart = {};
        renderCart();
    }

    function renderKitchen() {
        const search = document.getElementById('kitchen-search').value.toLowerCase();
        const ords = db.sales
            .filter(s => s.type === 'TakeAway')
            .sort((a, b) => new Date(a.pickupSort) - new Date(b.pickupSort));

        let tot = {};
        ords.filter(o => !o.pickedUp).forEach(o => o.items.forEach(i => tot[i.name] = (tot[i.name] || 0) + i.qty));

        document.getElementById('kitchen-summary').innerHTML =
            Object.keys(tot).length
                ? Object.entries(tot).map(([n, q]) => `<div class="prod-item-summary"><span>${n}</span><span>${q}</span></div>`).join('')
                : "<p>Nada pendiente.</p>";

        const pend = ords.filter(o => !o.pickedUp && (o.client.toLowerCase().includes(search) || o.details.toLowerCase().includes(search)));

        document.getElementById('kitchen-orders-pending').innerHTML =
            pend.length ? pend.map(o => createOrderCard(o)).join('') : '<p style="color:#999">No hay pendientes.</p>';

        document.getElementById('kitchen-orders-completed').innerHTML =
            ords.filter(o => o.pickedUp).slice(0, 10).map(o => createOrderCard(o, true)).join('');
    }

    function createOrderCard(o, done = false) {
        const d = new Date(o.pickupSort).toLocaleDateString('es-AR', { weekday:'long', day:'numeric', hour:'2-digit', minute:'2-digit' });
        const paid = o.method !== 'Pendiente';
        let btn;
        if (done) {
            btn = '<div style="text-align:right;color:green">‚úÖ Retirado</div>';
        } else {
            btn = paid
                ? `<button onclick="markAsPickedUp(${o.id})" class="btn btn-success" style="width:100%">‚úÖ Entregar (Pago)</button>`
                : `<button onclick="payAndPickup(${o.id})" class="btn btn-primary" style="width:100%">üíµ Cobrar y Entregar</button>`;
        }
        return `
            <div class="order-card ${(!paid && !done) ? 'pending' : ''} ${done ? 'completed' : ''}">
                <div style="display:flex;justify-content:space-between">
                    <strong>üìÜ ${d}</strong>
                    <span style="font-size:0.9rem;background:#eee;padding:2px 5px;border-radius:4px">
                        ${paid ? 'Pagado' : 'üî¥ Debe: ' + formatMoney(o.total)}
                    </span>
                </div>
                <div style="font-size:1.1rem;color:var(--primary);margin:5px 0">üë§ ${o.client}</div>
                <div>${o.details}</div>
                ${o.note ? `<div style="font-style:italic;color:#666">üìù ${o.note}</div>` : ''}
                <div class="action-area">${btn}</div>
            </div>`;
    }

    function markAsPickedUp(id) {
        if (confirm("¬øEntregar?")) {
            const o = db.sales.find(s => s.id === id);
            if (o) {
                o.pickedUp = true;
                saveDB();
                renderKitchen();
                renderSalesTable();

                // Sincronizar estado 'entregado' con la nube
                fetch(`https://pancomiddo-backend.onrender.com/actualizar-venta/${o.id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cliente_id: db.clients.find(c => c.name === o.client)?.id || null,
                        total: o.total,
                        metodoPago: o.method,
                        tipo: o.type,
                        nota: o.note,
                        infoRetiro: o.pickupInfo,
                        entregado: true
                    })
                }).catch(err => console.error(err));
            }
        }
    }

    function payAndPickup(id) {
        const sale = db.sales.find(s => s.id === id);
        if (!sale) return;
        openCheckoutModal(sale);
    }

    function renderSalesTable() {
        document.getElementById('sales-table-body').innerHTML =
            db.sales.slice(0, 100).map(s => `
                <tr style="${editingSaleId === s.id ? 'background:#fff3cd' : ''}">
                    <td>${s.date}</td>
                    <td>${s.type}</td>
                    <td>${s.client}</td>
                    <td>
                        ${s.details}<br>
                        <small style="color:#666">${s.note || ''}</small>
                    </td>
                    <td>${formatMoney(s.total)}</td>
                    <td>${s.method}</td>
                    <td style="white-space:nowrap;">
                        <button class="btn-msg"  onclick="viewOrderMsg(${s.id})"  title="Ver Mensaje">üí¨</button>
                        <button class="btn-edit" onclick="loadSaleForEdit(${s.id})" title="Editar Pedido Completo">‚úèÔ∏è</button>
                        <button class="btn-del"  onclick="deleteSale(${s.id})"      title="Borrar">üóëÔ∏è</button>
                    </td>
                </tr>
            `).join('');
    }

    function deleteSale(id) {
        if (prompt('üîê Ingresa "pancomiddo":') === "pancomiddo") {
            db.sales = db.sales.filter(s => s.id !== id);
            saveDB();
            renderSalesTable();
            renderKitchen();
            updateReport();

            // Sincronizar borrado con la nube
            fetch(`https://pancomiddo-backend.onrender.com/borrar-venta/${id}`, {
                method: 'DELETE'
            }).catch(err => console.error("Error al borrar en nube", err));
        }
    }

    function updateReport() {
        const t = new Date().toLocaleDateString();
        let s = {Efectivo:0, 'Mercado Pago':0, Transferencia:0, Pendiente:0};

        db.sales
            .filter(x => new Date(x.timestamp).toLocaleDateString() === t)
            .forEach(x => {
                if (s[x.method] !== undefined) s[x.method] += x.total;
            });

        document.getElementById('total-efectivo').innerText = formatMoney(s['Efectivo']);
        document.getElementById('total-mp').innerText       = formatMoney(s['Mercado Pago']);
        document.getElementById('total-transf').innerText   = formatMoney(s['Transferencia']);
        document.getElementById('total-pendiente').innerText= formatMoney(s['Pendiente']);
        document.getElementById('grand-total').innerText    = formatMoney(Object.values(s).reduce((a,b) => a + b, 0));
    }

    function renderAnalytics() {
        let p = {}, c = {};

        db.sales.forEach(s => {
            s.items.forEach(i => p[i.name] = (p[i.name] || 0) + i.qty);
            if (s.client !== 'Mostrador') {
                c[s.client] = (c[s.client] || 0) + s.total;
            }
        });

        const prodEntries = Object.entries(p).sort((a, b) => b[1] - a[1]);
        const clientEntries = Object.entries(c).sort((a, b) => b[1] - a[1]);

        renderBars('report-top-products', prodEntries.slice(0, 5), prodEntries[0]?.[1], ' u.');
        renderBars('report-top-clients', clientEntries.slice(0, 5), clientEntries[0]?.[1], '$');
    }

    function renderBars(el, d, m, s) {
        document.getElementById(el).innerHTML =
            d.length
                ? d.map(([l, v]) => `
                    <div class="bar-container">
                        <div class="bar-label">
                            <span>${l}</span>
                            <strong>${s === '$' ? formatMoney(v) : (v + s)}</strong>
                        </div>
                        <div class="bar-bg">
                            <div class="bar-fill" style="width:${(v / m) * 100}%"></div>
                        </div>
                    </div>
                `).join('')
                : '<p>Sin datos.</p>';
    }

    function addProduct() {
        const n = document.getElementById('prod-name').value;
        const p = document.getElementById('prod-price').value;
        if (n && p) {
            db.products.push({ id: Date.now(), name: n, price: parseFloat(p) });
            saveDB();
            renderProductsTable();
            renderProductsPOS();
        }
    }

    function renderProductsTable(f = "") {
        const filtro = f.toLowerCase();
        document.getElementById('products-table-body').innerHTML =
            db.products
                .filter(p => p.name.toLowerCase().includes(filtro))
                .map(p => `
                    <tr>
                        <td>${p.name}</td>
                        <td>${formatMoney(p.price)}</td>
                        <td>
                            <button class="btn-edit" onclick="editProduct(${p.id})">‚úèÔ∏è</button>
                            <button class="btn-del"  onclick="deleteProduct(${p.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
    }

    function deleteProduct(id) {
        if (confirm("¬øBorrar?")) {
            db.products = db.products.filter(x => x.id !== id);
            saveDB();
            renderProductsTable();
            renderProductsPOS();
        }
    }

    function editProduct(id) {
        const p = db.products.find(x => x.id === id);
        if (!p) return;
        const n = prompt("Nombre:", p.name);
        if (n) {
            const pr = prompt("Precio:", p.price);
            if (pr) {
                p.name = n;
                p.price = parseFloat(pr);
                saveDB();
                renderProductsTable();
                renderProductsPOS();
            }
        }
    }

    function addClient() {
        const n = document.getElementById('client-name').value;
        const p = document.getElementById('client-phone').value;
        if (n) {
            db.clients.push({ id: Date.now(), name: n, phone: p });
            saveDB();
            renderClientsTable();
            renderClientSearchList();
        }
    }

    function renderClientsTable(f = "") {
        const filtro = f.toLowerCase();
        document.getElementById('clients-table-body').innerHTML =
            db.clients
                .filter(c => c.name.toLowerCase().includes(filtro))
                .map(c => `
                    <tr>
                        <td>${c.name}</td>
                        <td>${c.phone || ''}</td>
                        <td>
                            <button class="btn-edit" onclick="editClient(${c.id})">‚úèÔ∏è</button>
                            <button class="btn-del"  onclick="deleteClient(${c.id})">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
    }

    function deleteClient(id) {
        if (confirm("¬øBorrar?")) {
            db.clients = db.clients.filter(x => x.id !== id);
            saveDB();
            renderClientsTable();
            renderClientSearchList();
        }
    }

    function editClient(id) {
        const c = db.clients.find(x => x.id === id);
        if (!c) return;
        const n = prompt("Nombre:", c.name);
        if (n) {
            c.name = n;
            c.phone = prompt("Tel:", c.phone) || c.phone;
            saveDB();
            renderClientsTable();
            renderClientSearchList();
        }
    }

    function saveClientFromModal() {
        const n = document.getElementById('modal-client-name').value;
        const phone = document.getElementById('modal-client-phone').value;
        if (n) {
            db.clients.push({ id: Date.now(), name: n, phone: phone });
            saveDB();
            document.getElementById('pos-client-search').value = n;
            document.getElementById('pos-client-list').style.display = 'none';
            document.getElementById('modal-new-client').style.display = 'none';
            document.getElementById('modal-client-name').value = '';
            document.getElementById('modal-client-phone').value = '';
        }
    }

    init();
</script>
</body>
</html>
